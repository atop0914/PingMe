# PingMe 故障演练指南

## 概述

本文档描述 PingMe IM 系统的故障演练方案，用于验证系统的容错能力、恢复能力和可观测性。

## 演练环境

- **环境**: 开发/测试环境
- **依赖**: Redis、Kafka、MySQL
- **监控**: 日志、Prometheus 指标

## 演练项目

### 1. Redis 故障演练

#### 1.1 Redis 连接断开
**目标**: 验证 Redis 不可用时的系统行为

**步骤**:
```bash
# 模拟 Redis 不可用
docker stop redis

# 观察:
# - Gateway 是否正常（本地连接仍可用）
# - 消息是否正常落库（不依赖 Redis 在线状态）
# - 错误日志是否正确记录

# 恢复 Redis
docker start redis
```

**预期结果**:
- 本地连接不受影响
- 消息通过 Kafka 异步处理
- 日志记录 Redis 连接错误
- 恢复后自动重连

#### 1.2 Redis 性能下降
**目标**: 验证 Redis 延迟高时的降级策略

**步骤**:
```bash
# 使用 redis-cli 模拟慢查询
redis-cli DEBUG SLEEP 1
```

**预期结果**:
- 系统日志记录慢查询警告
- 触发降级策略（使用本地缓存）
- 不阻塞核心业务流程

### 2. Kafka 故障演练

#### 2.1 Kafka 不可用
**目标**: 验证 Kafka 不可用时的消息处理

**步骤**:
```bash
# 停止 Kafka
docker stop kafka

# 发送消息测试
# 观察消息是否进入本地队列或重试
```

**预期结果**:
- 消息发送失败，返回错误
- 本地保留消息等待重试
- 日志记录 Kafka 不可用错误
- 恢复后自动重发

#### 2.2 Kafka 消息堆积
**目标**: 验证消息积压时的告警和处理

**步骤**:
```bash
# 停止消费者
# 大量发送消息

# 检查堆积数量
kafka-consumer-groups.sh --bootstrap-server localhost:9092 \
  --group pingme-group --describe
```

**预期结果**:
- 触发告警（lag > 1000）
- 日志记录消费延迟
- 恢复后逐步消费积压消息

### 3. 数据库故障演练

#### 3.1 MySQL 连接断开
**目标**: 验证数据库不可用时的系统行为

**步骤**:
```bash
# 停止 MySQL
docker stop mysql

# 观察:
# - HTTP 接口是否返回 503
# - WebSocket 消息是否正常
```

**预期结果**:
- HTTP 读操作降级（使用缓存）
- HTTP 写操作返回错误
- WebSocket 消息通过本地队列缓存
- 恢复后同步数据

### 4. 网络故障演练

#### 4.1 实例间网络断开
**目标**: 验证多实例部署时的网络分区

**步骤**:
```bash
# 模拟网络分区
iptables -A INPUT -s <instance_ip> -j DROP

# 观察:
# - 用户是否被标记为离线
# - 消息是否正确路由
```

**预期结果**:
- 用户状态标记为离线
- 消息正确落库
- 网络恢复后同步状态

### 5. 熔断器演练

#### 5.1 触发熔断
**目标**: 验证熔断器正常工作

**步骤**:
```bash
# 连续触发 5 次失败操作
# 观察熔断器状态变化
```

**预期结果**:
- 失败 5 次后熔断器打开
- 后续请求直接返回降级响应
- 30 秒后半开状态
- 成功后关闭熔断器

### 6. 资源清理演练

#### 6.1 内存泄漏检测
**目标**: 验证内存资源管理

**步骤**:
```bash
# 观察内存使用
# 检查 goroutine 数量
curl -s localhost:9090/metrics | grep goroutine
```

**预期结果**:
- 内存使用稳定
- goroutine 数量在合理范围
- 长时间运行无内存增长

## 监控指标

### 关键指标

| 指标名称 | 描述 | 告警阈值 |
|---------|------|---------|
| `websocket_connections` | WebSocket 连接数 | > 10000 |
| `kafka_consumer_lag` | Kafka 消费延迟 | > 1000 |
| `p99_latency_ms` | P99 延迟 | > 1000ms |
| `error_rate` | 错误率 | > 5% |
| `memory_usage_percent` | 内存使用率 | > 85% |

### 日志关键字

- `circuit_breaker_open`: 熔断器打开
- `redis_connection_failed`: Redis 连接失败
- `kafka_produce_failed`: Kafka 生产失败
- `database_connection_failed`: 数据库连接失败
- `resource_cleanup`: 资源清理

## 故障恢复流程

1. **检测**: 监控系统发现异常
2. **告警**: 发送告警通知
3. **定位**: 查看日志和指标
4. **止血**: 启用降级或熔断
5. **恢复**: 修复问题
6. **验证**: 确认服务正常

## 演练清单

- [ ] Redis 故障
- [ ] Kafka 故障
- [ ] 数据库故障
- [ ] 网络分区
- [ ] 熔断器触发
- [ ] 资源泄漏
- [ ] 高并发压测

## 注意事项

1. **生产环境谨慎**: 故障演练必须在非生产环境进行
2. **提前通知**: 提前通知相关人员
3. **准备回滚**: 准备快速回滚方案
4. **监控告警**: 确保监控告警通道畅通
5. **记录时间**: 记录故障时长和影响范围
